The Flask Mega-Tutorial Part XV: A Better Application Structure
===

原文地址: [The Flask Mega-Tutorial Part XV: A Better Application Structure](https://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-xv-a-better-application-structure)

这是 Flask Mega-Tutorial 系列的第十五篇文章了，在这里我将使用一种适合更大型应用的风格来重构应用。

目前博客应用的大小适中，所以我考虑现在是讨论 Flask 应用如何增长但是不会导致太混乱以致无法管理的好时候。Flask 是一个提供给你以任意方式组织项目的框架，而且作为它的设计哲学，它也使得当应用变大的时候改变或者调整应用结构成为可能，或者当你的需求，经验层级改变的时候。

在本章我将讨论一些应用于大型应用的一些模式，为了说明它们我将对我的博客项目的结构做一些改变，让代码变得更加可维护并且组织良好。当然，以真正的 Flask 精神，我鼓励你在组织你自己的项目的时候将这些改变作为一个建议。

本章的 Github 链接为：[Browse](https://github.com/miguelgrinberg/microblog/tree/v0.15), [Zip](https://github.com/miguelgrinberg/microblog/archive/v0.15.zip), [Diff](https://github.com/miguelgrinberg/microblog/compare/v0.14...v0.15)

当前的限制
===

应用在当前状态下主要有两个基本问题。如果你查看应用是如何组织的，你将会注意到应用目前有几个不同的子系统，但是它们的代码都是混在一起的，没有明确的界限，让我们分析下这些子系统都是什么：

- 用户验证子系统，包含一些在 `app/routes.py` 下的一些视图函数，在 `app/forms.py` 下的一些表单，在 `app/templates` 下的一些模板以及在 `app/email.py` 下的电子邮件支持
- 错误处理子系统，在 `app/errors.py` 中定义的错误处理器以及 `app/templates` 下的模板
- 核心应用功能，包含展示，创建和更新博客文章，用户资料和用户关注关系，以及博客文章的即时翻译，这些功能遍布应用的大部分模块和模板中。

仔细考虑下这三个子系统以及它们是如何组织的，你应该会注意到一个模式。我目前遵循的组织逻辑是基于每个模块专注于不同的应用功能。比如有模块专门处理视图函数，另一个模块用于 web 表单，一个用于错误，另一个用于电子邮件，一个目录用于 HTML 模板等等。这样的结构对于小的项目是满足的，但是一旦项目开始增长，这将会导致这些模块非常大而且混乱。

一种能清晰的看到这个问题的方式是考虑通过重用这个项目的代码来重新开始另一个项目。比如，用户验证部分应该在其他应用是可以正常工作的，但是如果你想使用这部分带啊吗，你需要去好几个不同的模块里去复制粘贴对应部分的代码到新项目的文件里。很不方便吧？如果用户验证相关的文件和应用其他部分是分开的话岂不是更好？Flask 的 `blueprints` 特性帮助实现一个更加可用的组织方式并且使得重用代码变的容易。

第二个问题不是那么明显。Flask 应用实例是在 `app/__init__.py` 中以全局变量的形式创建的，然后被导入到了许多应用模块里。当然这并不是一个问题，但是以全局变量的形式创建应用会使得一些场景变得复杂，比如测试。想象下你想在不同的配置下测试你的应用。因为应用是以全局变量的形式定义的，所以你没法使用不同的环境变量来实例化两套应用。另外所有的测试都使用同样的应用是不合适的，一个测试可能会对应用作出改变，这样会影响后面测试的运行。理想情况是所有的测试都在全新的应用实例上运行。

你可以在 `tests.py` 中看到我在应用已经设置配置之后改变配置，从而使得应用使用内存数据库而不是默认的 SQLite 数据库。我确实没有其他办法来改变配置的数据库，因为在测试启动的时候应用已经创建并且配置好了。对于这种特定的情况，在配置已经应用到应用上之后改变配置是可以正常工作的。但是在其他情况下，无论如何，它都是一个糟糕的方法，因为可能导致晦涩并且难以发现的问题。

更好的方式是不要使用全局变量来创建应用，而是在运行的时候使用应用工厂函数来创建。这是一个接受配置对象为参数的函数，并且会返回一个已经配置的 Flask 应用实例。如果我修改应用以采用应用工厂函数，那么对于需要不同配置的测试用例将非常容易，因为每个测试都可以创建它自己的应用。

在这章，我将重构应用，使用蓝图和应用工厂函数。展示出修改的每一个细节是不切实际的，因此我将讨论重构的步骤，之后你可以下载应用来详细查看修改的细节。

蓝图
===
